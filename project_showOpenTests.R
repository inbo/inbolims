######################################################
######### SHOW OPEN TESTS IN PROJECT #################
######### ############################################


### >>> CONFIGURE R SESSION ###
### ----------------------- ###

#rootdirectory nodig omdat Citrix niet omkan met relatieve padverwijzingen

args <- commandArgs()

if (length(args) < 6) {
  rootdirectory <- "C:\\INSYNC\\PROJECTEN_GIT/_LABO/inbolims/"
  source(paste0(rootdirectory, "R_SCRIPTS\\FUNCTIONS\\fun_db_credentials.R"))
  args <- readCreds(additional_vars = list(groups = " GROUP_NAME in ('WATER')")) #--let op testwaarde ingevuld
} else {
  rootdirectory <- "\\\\LimsBGOPS.inbo.be\\Labware7\\Labware-7\\Data\\"
}

#load libraries - current workdir = source file location
library(RODBC)

# set new work directory
setwd(paste0(rootdirectory, "R_WORKDIR\\_GENERIEK"))
outdir <- getwd()
logfile <- file.path(getwd(), "opentests.log")

#db parameters and variables - working directory must be source location of script file
dbodbc <- args[6]
dbuid <- args[7]
dbpwd <- args[8]
groupClause <- args[9]

#init logfile
sink(file = logfile, append = FALSE)
sink()


### >>> DB CONNECTIES ###
### ----------------  ###

cat("Start connecting db\n", file = logfile, append = TRUE)
today <- Sys.Date()

qry <- paste0("
select * from (
select p.NAME, t.analysis, Openstaand = count(t.test_number)
from test t
inner join sample s on t.SAMPLE_NUMBER = s.SAMPLE_NUMBER
inner join project p on s.PROJECT = p.NAME
where p.status in ('C', 'P', 'I', 'U')
and s.status in ('P', 'I')
and t.status in ('P', 'I')
and p.", trimws(groupClause),
" group by t.analysis, p.NAME) as src"
)


### >>> EXECUTE SQL ###
### --------------- ###
cat(paste0("query:\n", qry), file = logfile, append = TRUE)

conn <- odbcConnect(dsn = dbodbc, uid = dbuid, pwd = dbpwd)
Data <- sqlQuery(conn, qry)
odbcClose(conn)

cat(str(Data), file = file, append = TRUE)

### EINDE SCRIPT ###

